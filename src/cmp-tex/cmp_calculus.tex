\section{Calculus}





\subsection{Terms and Contexts}
%--------------------------------------------------------------------------------



The terms are generated by the grammar
%
$$
\begin{array}{llll}
    t
    &::=&
    \Prop
    &\text{propositional sort}
    \\
    &\mid&
    \Any
    &\text{computational sort}
    \\
    &\mid&
    c
    &\text{constants (numbers, strings, $\ldots$)}
    \\
    &\mid&
    x
    &\text{variables}
    \\
    &\mid&
    \meta m
    &\text{metavariables}
    \\
    &\mid&
    \Make
    &\text{constructors}
    \\
    &\mid&
    f \vec a
    & \text{application}
    \\
    &\mid&
    \lambda \vec x^{\vec A}. e
    & \text{abstractions}
    \\
    &\mid&
    \Pi \vec x^{\vec A}. B
    & \text{products}
    \\
    &\mid&
    \llet[\vec x := \vec a \mid e]
    & \text{let expressions}
    \\
    &\mid&
    \type[\Gamma \mid I^K \mid \vec C]
    & \text{inductive types}
    \\
    &\mid&
    \case[f^F \mid \vec c \mid t]
    & \text{case expressions}
    \\
    &\mid&
    \cta[f, t, \vec u, p]
    &\text{case tree application}
\end{array}
$$
%
and contexts are generated by the grammar
$$
\begin{array}{llll}
    \Gamma
    &::=&
    []
    &\text{empty context}
    \\
    &\mid&
    \Gamma, x^A
    &\text{local variable}
    \\
    &\mid&
    \Gamma, (x^A := a)
    &\text{definition}
    \\
    &\mid&
    \Gamma, \meta m^M
    &\text{meta variable}
    \\
    &\mid&
    \Gamma, (\meta m^M := a)
    &\text{meta variable instantiation}
\end{array}
$$






\subsection{Head Reductions}
%--------------------------------------------------------------------------------

The following head reductions are possible:
$$
\begin{array}{llll}
        \Gamma \vdash (\lambda \vec x^{\vec A}. e) \vec a \vec b
        &\reduce&
        \Gamma, [\vec x^{\vec A} := \vec a] \vdash e \vec b
        \\
        \Gamma \vdash \llet[\vec x^{\vec A} := \vec a , e] \vec b
        &\reduce&
        \Gamma, [\vec x^{\vec A} := \vec a] \vdash e \vec b
        \\
        \Gamma \vdash \case[*, *, t] \vec a \vec b
        &\reduce&
        \Gamma \vdash \cta[\case[*,*,t], t, \empty, p.f = a_1] \vec b
        \\
        \Gamma \vdash \cta[*, t_1, \vec u_1, p_1] \vec b
        &\reduce&
        \Gamma \vdash \cta[*, t_2, \vec u_2, p_2] \vec b
        \\
        \Gamma
        \vdash
        \cta(\text{pm}, e, \vec u, \empty) \vec b
        %
        &\reduce&
        %
        \Gamma, [f,\vec x := \text{pm}, \vec u]
        \vdash
        e \vec b
        \\
        \\
        \Gamma \vdash x \vec b
        &\reduce&
        \Gamma \vdash a \vec b
\end{array}
$$

The last reduction is an unfolding of a definition i.e. $(x:=a) \in \Gamma$ is
assumed. A case tree application can become stuck if the focal term does not
allow a decision.

Note that the head reductions make only substitutions of head terms. Instead of
substitutions variables with definitions are introduced.






\subsection{Typing Rules}
%--------------------------------------------------------------------------------

We introduce two relations.
$$
\Gamma \vdash t: T
$$
means in the context $\Gamma$ the term $t$ has type $T$.
$$
\Gamma \vdash A \le B
$$
means $A$ and $B$ are welltyped in the context $\Gamma$ and $A$ is a subtype of
$B$.





The rules for $\Gamma \vdash t : T$:

$$
\vertlist {
    \text{axiom} &
    %----------------
    [] \vdash \Prop: \Any_0
    \quad
    \rulev{
        i < j
    }
    {
        [] \vdash \Any_i : \Any_j
    }
    \\
    \\
    \text{var add} &
    %----------------
    \rulev{
        \Gamma \vdash A: s
    }
    {
        \Gamma, x^A \vdash x: A
    }
    \quad
    \rulev{
        \Gamma \vdash a: A
    }
    {
        \Gamma, [x^A := a] \vdash x: A
    }
    \\
    \\
    \text{def elim} &
    %----------------
    \rulev{
        \Gamma, [x^A:= a] \vdash t : T
    }
    {
        \Gamma \vdash t[a/x] : T[a/x]
    }
    \quad
    \rulev{
        \Gamma, [x^A:= a] \vdash t : T
    }
    {
        \Gamma, x^A \vdash t : T
    }
    \\
    \\
    \text{product} &
    %----------------
    \rulev{
        \Gamma \vdash A: s
        \\
        \Gamma, x^A \vdash B: \Prop
    }
    {
        \Gamma \vdash \Pi x^A. B: \Prop
    }
    \quad
    \rulev{
        \Gamma \vdash A: \Any_i
        \\
        \Gamma, x^A \vdash B: \Any_j
    }
    {
        \Gamma \vdash \Pi x^A. B: \Any_{\text{max}(i,j)}
    }
    \\
    \\
    \text{lambda} &
    %----------------
    \rulev{
        \Gamma, x^A \vdash e : B
    }
    {
        \Gamma \vdash \lambda x^A. e := \Pi x^A. B
    }
    \\
    \\
    \text{app} &
    %----------------
    \rulev{
        \Gamma \vdash f : \Pi x^A. B
        \\
        \Gamma \vdash a: A
    }
    {
        \Gamma, [x^A := a] \vdash f x: B
    }
    \\
    \\
    \text{weaken} &
    %----------------
    \rulev{
        \Gamma \vdash t: T
        \\
        \Gamma \vdash A: s
    }
    {
        \Gamma, x^A \vdash t : T
    }
    \quad
    \rulev{
        \Gamma \vdash t: T
        \\
        \Gamma \vdash a: A
    }
    {
        \Gamma, [x^A:=a] \vdash t : T
    }
    \\
    \\
    \text{subtype} &
    %----------------
    \rulev{
        \Gamma \vdash t : T
        \\
        \Gamma \vdash T \le U
    }
    {
        \Gamma \vdash t: U
    }
}
$$


The rules for $\Gamma \vdash A \le B$:
$$
\vertlist {
    \text{same} &
    %---------------
    \rulev {
        \Gamma \vdash A: s
    }
    {
        \Gamma \vdash A \le A
    }
    \\
    \\
    \text{weaken} &
    %---------------
    \rulev {
        \Gamma \vdash T \le U
        \\
        \Gamma \vdash A : s
    }
    {
        \Gamma, x^A \vdash T \le U
    }
    \quad
    \rulev {
        \Gamma \vdash T \le U
        \\
        \Gamma \vdash a: A
    }
    {
        \Gamma, [x^A := a] \vdash T \le U
    }
}
$$
