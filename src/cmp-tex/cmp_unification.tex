\section{Unification}






\subsection{Description of the Problem}
%--------------------------------------------------------------------------------

Whenever a function is applied to an actual argument then the type of the actual
argument $A$ has to be a subtype of the type of the formal argument $R$ i.e. $A
\le R$ has to be valid. Otherwise the actual argument is not a legal argument to
the function. Without metavariables and performance considerations the solution
is quite simple:

\begin{itemize}

    \item Transform both types into normal form. Since both are types their normal
        forms have to be products with zero or more arguments and the result type is
        either a sort or a base term i.e. the have one of the forms
        $$
        \begin{array}{l}
            \Pi x_1^{A_1} \ldots x_n^{A_n}. x \vec a
            \\
            \Pi x_1^{A_1} \ldots x_n^{A_n}. s
        \end{array}
        $$

    \item Check that both have the same number of arguments and  all argument types
        are identical.

    \item The result types have to be either both base terms or sorts. In case of
        base terms both have to be identical. In case of sorts the sort of the actual
        argument type has to be a subtype of the sort of the formal argument type.

\end{itemize}


There are two problems with this approach:

\begin{itemize}

    \item The source code is not fully annotated. Metavariables are introduced
        during elaboration for terms missing in the source code. The elaborator
        has to instantiate these metavariables.

    \item A complete normalization performs a lot of function unfolding, case
        expression reductions, let term reductions and beta reductions.
        Operation of let and beta reduction is variable substitution in terms.
        Since variables can occur several times in terms the normalized terms
        can be considerably large even growing exponentially. Consider that
        there are 10 beta reductions which duplicate a term. If this duplication
        is nested then there are finally 1014 duplicates.

        Furthermore case term reductions can grow exponentially in the worst
        case.

        Therefore reduction to complete normal form can be a performance
        problem.
\end{itemize}


We work with contexts
$$
    \Gamma ::= [] \mid \Gamma,x^A \mid \Gamma, x^A := a \mid \Gamma, \meta m^M
                \mid \Gamma, \meta m^M := a
$$
Clearly duplicate names are not allowed.

The unification problem looks like
$$
\Gamma \vdash A \le R
$$
where $A$ and $R$ are welltyped in the context $\Gamma$.





\subsection{Metavariables}
%--------------------------------------------------------------------------------


Metavariables are introduced when there is something unknown in a certain
context (e.g. a missing type, an implicit variable). Each metavariable has a
type $\Gamma \vdash \meta m : M$. I.e. metavariables are required to be
welltyped.

The type $M$ of a metavariable is a required type. The actual type used in
instantiations can be a subtype of $M$.

If we have two metavariables $\meta m_1$ and $\meta m_2$ and both are separated
in the context by a free variable (i.e. variable without definition $\Gamma = [
    \ldots, \meta m_1^{M_1}, \ldots x^A, \ldots, \meta m_2^{M_2}, \ldots]$) then
the meta variable $m_2$ is an \emph{inner metavariable} with respect to $\meta
m_1$. Metavariables which are not separated by free variables are in the same
group.

Metavariables can be \emph{instantiated} during unification. Whenever there is a
unification condition of one of the forms
$$
\begin{array}{lllll}
    \Gamma &\vdash &\meta m \vec x &\le &t^T
    \\
    \Gamma &\vdash &t^T &\le &\meta m \vec x
\end{array}
$$
we can instantiate
$$
    \meta m := \lambda \vec x ^{\vec A}. t
$$
where $\Gamma \vdash \lambda \vec x^{\vec A}. t : \Pi \vec x^{\vec A}. T$ under
the conditions
\begin{enumerate}

    \item $\meta m$ does not yet have a definition.

    \item $\vec x$ are free variables without duplicate, without definitions
        with the corresponding types $\vec A$ in the context $\Gamma$.

    \item $\text{FV}(t) \subseteq \set{\vec x}$.

    \item $t$ does not contain neither directly or indirectly neither $\vec m$
        nor more inner metavariables.

    \item $\Pi \vec x^{\vec A}. T \le M$.
\end{enumerate}

This instantiation makes $\meta m \vec x$ and $t$ equivalent which can be easily
proved by beta reduction. Therefore it is not important if
$\meta m \vec x$ is required to be a subtype or a supertype of $t$.





\subsection{Head Normal Forms}
%--------------------------------------------------------------------------------

We assume that terms are generated by the grammar
$$
\begin{array}{llll}
    t
    &::=& x & \text{variables}
    \\
    &\mid&
    \meta m
    &\text{metavariables}
    \\
    &\mid&
    \Make_\ell
    &\text{constructors}
    \\
    &\mid&
    f \vec a
    & \text{application}
    \\
    &\mid&
    \lambda \vec x^{\vec A}. e
    & \text{abstractions}
    \\
    &\mid&
    \Pi \vec x^{\vec A}. B
    & \text{products}
    \\
    &\mid&
    \llet[\vec x := \vec a \mid e]
    & \text{let expressions}
    \\
    &\mid&
    \case[f^F \mid \vec c \mid t]
    & \text{case expressions}
    \\
    &\mid&
    \type[\Gamma \mid I^K \mid \vec C]
    & \text{inductive types}
\end{array}
$$

The \emph{prime} terms are variables, metavariables, constructors and inductive
definitions.

The following terms are in \emph{head normal form}
\begin{enumerate}
    \item Base terms $x \vec a$ where $x$ is a prime term i.e. either a variable,
        metavariable, constructor or inductive type or $x$ is a case expression
        which cannot be reduced by analyzing its arguments $\vec a$ with the help
        of its case tree.

    \item Abstractions

    \item Products
\end{enumerate}

The following terms are not unifiable:
\begin{enumerate}
    \item Two terms in head normal form of different structure are mutually not
        unifiable except one of them is a base term with a head symbol which has
        a definition.

    \item Two base terms with different constructors, different free variables
        without definition or one of them a constructor and the other a variable
        without definition in the head position.
\end{enumerate}

A term $t$ in a context $\Gamma$ can be transformed into head normal form by the
following transformations head reductions:
$$
\begin{array}{lll}
    \Gamma \vdash (\lambda \vec x^{\vec A}. e) \vec a \vec b
    &\leadsto&
    \Gamma, \vec x^{\vec A} := \vec a \vdash e \vec b
    \\
    %
    \Gamma \vdash \llet[\vec x^{\vec A} := \vec aÂ \mid e] \vec b
    &\leadsto&
    \Gamma, \vec x^{\vec A} := \vec a \vdash e \vec b
    \\
    %
    \Gamma \vdash \case[f^F \mid \vec c \mid t] \vec a \vec b
    &\leadsto&
    \Gamma \vdash e[\case [f^F \mid \vec c \mid t] / f] \; \vec b
\end{array}
$$
where in the case expression $e$ is the right hand side of the case clause found
by the corrresponding case tree applied to the arguments $\vec a$.

A term is in head normal form if all head reductions are done which do not
involve the unfolding of definition.
